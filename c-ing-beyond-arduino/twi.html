<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2-wire Serial Interface - cu-summer-stem-embedded-systems</title>


        <!-- Custom HTML head -->

        <meta name="description" content="The Cooper Union - Summer STEM Embedded Systems: C-ing Beyond Arduino">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-3865ffda.css">
        <link rel="stylesheet" href="../css/general-4c35105a.css">
        <link rel="stylesheet" href="../css/chrome-c0e702bf.css">
        <link rel="stylesheet" href="../css/print-ad67d350.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome-799aeb25.css">
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight-56612340.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-d6b7fd1c.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-1f0f76cc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">cu-summer-stem-embedded-systems</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/jacobkoziej/cu-summer-stem-embedded-systems" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/jacobkoziej/cu-summer-stem-embedded-systems/edit/master/src/c-ing-beyond-arduino/twi.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="2-wire-serial-interface"><a class="header" href="#2-wire-serial-interface">2-wire Serial Interface</a></h1>
<p><em>“Did you know that the 2-wire serial interface is compatible with Phillips’ I2C protocol!?” - Matthew Jeong</em></p>
<h2 id="outline"><a class="header" href="#outline">Outline</a></h2>
<ul>
<li>I2C:
<ul>
<li>SDA &amp; SCL</li>
<li>Master vs slave devices</li>
<li>START and STOP conditions</li>
<li>Addressing</li>
<li>Reading vs writing</li>
<li>ACK vs NACK</li>
<li>Multi-master configuration</li>
</ul>
</li>
<li>TWI:
<ul>
<li>Modes of operation</li>
<li>TWI registers</li>
<li>Clock generation</li>
<li>TWI interrupt</li>
</ul>
</li>
<li>MPU-6050:
<ul>
<li>Applications</li>
<li>Requesting data</li>
<li>External interrupt</li>
</ul>
</li>
<li>Drivers:
<ul>
<li>Definition</li>
<li>Non-blocking, interrupt-driven design</li>
</ul>
</li>
</ul>
<h2 id="project"><a class="header" href="#project">Project</a></h2>
<p><em>MPU-6050 driver.</em></p>
<ol>
<li>
<p>Create a <code>twi</code> translation unit for your TWI driver.
This translation unit must at the very least contain the following functions:</p>
<ul>
<li><code>twi_status_t twi_init(const uint8_t scl_frequency)</code></li>
<li><code>twi_status_t twi_enqueue(twi_message_t *messages, size_t count)</code></li>
<li><code>twi_status_t twi_status(void)</code></li>
<li><code>twi_status_t twi_cancel(void)</code></li>
<li><code>twi_status_t twi_deinit(void)</code></li>
</ul>
<p>To simplify this assignment, we’ll only consider master mode operation.
To make our lives significantly easier, I suggest we take the following steps:</p>
<ol>
<li>Set the associated digital IO ports to inputs with their internal pull-up resistors enabled.
This will allow us to avoid having to attach external pull-up resistors. However, please note that with these enabled, we can’t set the SCL’s frequency above 100 kHz.</li>
<li><code>typedef</code> an <code>enum</code> called <code>twi_status_t</code>.
This <code>enum</code> should contain a list of TWI status codes your functions can return to indicate success, failure, or nominal operation.</li>
<li><code>typedef</code> a <code>struct</code> called <code>twi_message_t</code>.
This <code>struct</code> should contain a pointer to a <code>uint8_t</code> buffer our driver can read from/write to, along with a size for this buffer in bytes.</li>
<li>Define a <code>static</code> function for calculating our clock pre-scaler and <code>TWBR</code> values given an SCL frequency.</li>
<li>Populate <code>ISR(TWI_vect)</code> with an empty <code>switch</code>-<code>case</code> using constants defined in <a href="https://avrdudes.github.io/avr-libc/avr-libc-user-manual/group__util__twi.html"><code>&lt;util/twi.h&gt;</code></a> related to master mode.
Instead of directly <code>switch</code>ing on <code>TWSR</code>, utilize the <code>TW_STATUS</code> macro as it will automatically mask non-zero pre-scaler bits.
Do note that a few of the status operations can be the same, so fall-through <code>case</code>s might be useful to reduce code duplication.</li>
<li>Create a <code>static struct</code> local to the <code>twi</code> translation unit that will contain all variables we might share between the ISR and regular functions.</li>
<li><code>twi_init()</code> should set the SCL frequency on a best-effort basis, along with initializing the TWI peripheral to be in an idle state.
This function is also a great point to set default values for any variables we will use in our ISR.</li>
<li><code>twi_enqueue()</code> should pass a pointer to a message or array of messages (if we intend to utilize the repeat START condition) along with a count of the number of messages we’ll be transmitting to internal variables used in our ISR before successfully returning to the caller.
There should also be some basic checks in place here to ensure that we don’t interrupt an existing operation.
In the case of an ongoing operation, we should fail gracefully and return control to the caller.</li>
<li>At this point, we can start filling out our <code>switch</code>-<code>case</code> in our ISR.
I recommend looking at <a href="https://ww1.microchip.com/downloads/aemDocuments/documents/OTH/ApplicationNotes/ApplicationNotes/00002480A.pdf">application note AVR315</a>, which guides you through an <a href="https://ww1.microchip.com/downloads/en/AppNotes/Atmel-2564-Using-the-TWI-Module-as-I2C-Master_ApplicationNote_AVR315.zip">example master TWI driver</a>.<sup class="footnote-reference" id="fr-warning-1"><a href="#footnote-warning">1</a></sup>
If you read the AVR315 application note or ATmega328P datasheet, you’ll notice that the TWI peripheral is a state machine we control with a handful of registers.
I suggest tracing out possible execution paths and finding terminal states on success or failure.
In either case, you should pass status information to the user, along with indicating that the operation has concluded.</li>
<li><code>twi_status()</code> gives our calling code a glimpse into what’s happening in the background so that it can act accordingly.
Once the enqueued TWI operation is complete, this function should return success to the caller, who can access any read data or enqueue a new operation.</li>
<li>In the case of the I2C bus failing, you may want to timeout an operation.
<code>twi_cancel()</code> serves the purpose of rescuing our code from this limbo as opposed to hanging like older versions of the <a href="https://docs.arduino.cc/language-reference/en/functions/communication/wire/">Arduino Wire library</a>.</li>
<li>Finally, add the ability to disable TWI entirely with <code>twi_deinit()</code>.
In the case of an ongoing operation or an uninitialized TWI peripheral, this function should fail gracefully.</li>
</ol>
</li>
<li>
<p>Create an <code>mpu-6050</code> translation unit for your MPU-6050 driver.
<strong>Functions and steps are TBD.</strong></p>
</li>
</ol>
<hr>
<ol class="footnote-definition"><li id="footnote-warning">
<p>Be highly skeptical of manufacturer code or other code you find on the internet!
At least for the Atmel code linked above, it includes a few mistakes and poor design decisions:</p>
<ul>
<li>Unbounded busy loops checking <code>TWINT</code>, which may never be unset if the I2C bus is disconnected.</li>
<li>Variables shared between regular functions and the ISR that are not <code>volatile</code>.</li>
<li><code>TWSR</code> pre-scaler bits are not masked when checking TWI status bits, so a non-zero pre-scaler renders the driver useless.</li>
<li><code>TWCR</code> is always overwritten, irrespective of user settings.
For example, a user may wish to keep <code>TWEA</code> disabled for whatever reason.</li>
<li>Time and space get wasted copying buffered data to an internal TWI data buffer.</li>
</ul>
<p>There might not be all the errors, but the point still stands: code from manufacturers or the general internet should be nothing more than a reference and/or starting point, as opposed to an infallible source of truth! <a href="#fr-warning-1">↩</a></p>
</li>
</ol>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../c-ing-beyond-arduino/timers-&amp;-pwm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../examples/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../c-ing-beyond-arduino/timers-&amp;-pwm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../examples/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-9aeb6ddf.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-9576a2db.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
